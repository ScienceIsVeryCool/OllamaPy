name: Build & Install Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [created]

jobs:
  install-test:
    runs-on: self-hosted
    permissions:
      contents: read
      actions: write
    
    steps:
    - uses: actions/checkout@v5
    
    - name: Test Installation (PyPI Method)
      run: |
        echo "🐍 Testing installation method that users follow:"
        echo "Setting up Python environment..."
        python3 --version
        
        # Create virtual environment (as users would)
        python3 -m venv venv
        source venv/bin/activate
        pip install --upgrade pip
        
        echo "📦 Installing from source (as users would with: pip install -e .)..."
        pip install -e .
        
        echo "🧪 Testing basic functionality..."
        python -c "import ollamapy; print('✅ Package imported successfully')"
        ollamapy --help | head -5
        
        echo "✅ Installation test completed successfully"
    
    - name: Test Build Process
      run: |
        echo "🏗️ Testing build process..."
        source venv/bin/activate
        
        # Install build tools
        pip install build twine
        
        # Build package
        python -m build
        
        # Check package integrity
        python -m twine check dist/*
        
        echo "✅ Build process completed successfully"
    
    - name: Test Package Installation (Simulating PyPI)
      run: |
        echo "📦 Testing wheel installation (simulating: pip install ollamapy)..."
        
        # Create fresh environment
        python3 -m venv test_env
        source test_env/bin/activate
        pip install --upgrade pip
        
        # Install from built wheel
        pip install dist/*.whl
        
        # Test functionality
        python -c "import ollamapy; print('✅ Wheel installation successful')"
        ollamapy --help | head -5
        
        echo "✅ Package installation test completed successfully"